<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Vehicle Monitoring - Enterprise Dashboard</title>
    
    <!-- External Libraries -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    
    <style>
        :root {
            --primary: #0066ff;
            --primary-dark: #0052cc;
            --secondary: #6c757d;
            --success: #00d084;
            --danger: #ff4757;
            --warning: #ffa502;
            --info: #3742fa;
            --dark: #1a1d29;
            --darker: #0f1419;
            --light: #f8f9fa;
            --border: rgba(255, 255, 255, 0.1);
            --glass: rgba(255, 255, 255, 0.05);
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            --glow: 0 0 20px rgba(0, 102, 255, 0.3);
            --text-primary: #ffffff;
            --text-secondary: rgba(255, 255, 255, 0.7);
            --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-success: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            --gradient-danger: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            --gradient-warning: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --gradient-info: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #0c0c0c 0%, #1a1d29 25%, #2d3748 50%, #1a202c 75%, #0f1419 100%);
            background-size: 400% 400%;
            animation: gradientFlow 20s ease infinite;
            color: var(--text-primary);
            overflow-x: hidden;
            min-height: 100vh;
        }

        @keyframes gradientFlow {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        #particles-js {
            position: fixed;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            z-index: -1;
        }

        /* Navigation */
        .navbar {
            background: rgba(26, 29, 41, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
            box-shadow: var(--shadow);
            padding: 1rem 0;
        }

        .navbar-brand {
            font-size: 1.5rem;
            font-weight: 700;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .nav-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .status-badge {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--glass);
            border: 1px solid var(--border);
            border-radius: 50px;
            font-size: 0.875rem;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.1); }
        }

        /* Glass Cards */
        .glass-card {
            background: var(--glass);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            border-radius: 20px;
            box-shadow: var(--shadow);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .glass-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: left 0.8s ease;
        }

        .glass-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--glow), var(--shadow);
            border-color: var(--primary);
        }

        .glass-card:hover::before {
            left: 100%;
        }

        /* Header Section */
        .hero-section {
            text-align: center;
            padding: 3rem 0;
            position: relative;
        }

        .hero-title {
            font-size: 3.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #ffffff 0%, #0066ff 50%, #00d084 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 1rem;
            line-height: 1.2;
        }

        .hero-subtitle {
            font-size: 1.25rem;
            color: var(--text-secondary);
            margin-bottom: 2rem;
        }

        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .feature-card {
            background: var(--glass);
            border: 1px solid var(--border);
            border-radius: 15px;
            padding: 2rem;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .feature-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--gradient-primary);
        }

        .feature-card:hover {
            transform: translateY(-10px);
            box-shadow: var(--glow);
        }

        .feature-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Statistics Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--glass);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 2rem;
            text-align: center;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .stat-card::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .stat-card:hover::after {
            transform: scaleX(1);
        }

        .stat-number {
            font-size: 3rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            transition: all 0.3s ease;
        }

        .stat-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 500;
        }

        .stat-trend {
            margin-top: 0.5rem;
            font-size: 0.75rem;
        }

        .trend-up { color: var(--success); }
        .trend-down { color: var(--danger); }

        /* AI Model Info */
        .ai-model-card {
            background: linear-gradient(135deg, rgba(0, 102, 255, 0.1) 0%, rgba(116, 185, 255, 0.1) 100%);
            border: 1px solid rgba(0, 102, 255, 0.3);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
            position: relative;
        }

        .ai-model-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--gradient-info);
            border-radius: 20px 20px 0 0;
        }

        .performance-bar {
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
            margin: 1rem 0;
        }

        .performance-fill {
            height: 100%;
            background: var(--gradient-success);
            border-radius: 10px;
            transition: width 0.3s ease;
            position: relative;
        }

        .performance-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        /* Video Feed */
        .video-section {
            position: relative;
            border-radius: 20px;
            overflow: hidden;
            background: #000;
            min-height: 500px;
        }

        .video-header {
            display: flex;
            justify-content: between;
            align-items: center;
            padding: 1rem;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
        }

        .video-controls {
            display: flex;
            gap: 0.5rem;
        }

        .video-feed {
            width: 100%;
            height: auto;
            min-height: 400px;
            object-fit: cover;
        }

        .video-overlay {
            position: absolute;
            top: 1rem;
            left: 1rem;
            display: flex;
            gap: 0.5rem;
        }

        .live-badge {
            background: var(--danger);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            animation: pulse 2s infinite;
        }

        .fps-badge {
            background: var(--info);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        /* Traffic Flow */
        .traffic-flow {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1.5rem;
            background: var(--glass);
            border: 1px solid var(--border);
            border-radius: 15px;
            margin: 0.5rem 0;
            transition: all 0.3s ease;
        }

        .traffic-flow:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }

        .flow-icon {
            font-size: 2rem;
            color: var(--primary);
            animation: flowMove 2s ease-in-out infinite;
        }

        @keyframes flowMove {
            0%, 100% { transform: translateX(0); }
            50% { transform: translateX(10px); }
        }

        .flow-count {
            font-size: 2rem;
            font-weight: 700;
            background: var(--gradient-success);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Control Panel */
        .control-panel {
            background: var(--glass);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 2rem;
        }

        .btn-modern {
            border: none;
            border-radius: 50px;
            padding: 1rem 2rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .btn-modern::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }

        .btn-modern:hover::before {
            left: 100%;
        }

        .btn-modern:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .btn-start {
            background: var(--gradient-success);
            color: white;
        }

        .btn-stop {
            background: var(--gradient-danger);
            color: white;
        }

        .btn-export {
            background: var(--gradient-info);
            color: white;
        }

        /* Data Stream */
        .data-stream {
            font-family: 'JetBrains Mono', 'Fira Code', monospace;
            background: rgba(0, 0, 0, 0.9);
            color: var(--success);
            padding: 1.5rem;
            border-radius: 15px;
            height: 300px;
            overflow-y: auto;
            font-size: 0.875rem;
            line-height: 1.6;
            border: 1px solid var(--border);
        }

        .stream-line {
            margin: 0.25rem 0;
            opacity: 0;
            animation: streamIn 0.5s ease forwards;
        }

        @keyframes streamIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        /* Entry/Exit Table */
        .table-modern {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            overflow: hidden;
            border: 1px solid var(--border);
        }

        .table-modern thead th {
            background: rgba(0, 102, 255, 0.1);
            border: none;
            color: var(--primary);
            font-weight: 600;
            padding: 1rem;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 1px;
        }

        .table-modern tbody td {
            border: none;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            padding: 1rem;
            vertical-align: middle;
        }

        .table-modern tbody tr:hover {
            background: rgba(0, 102, 255, 0.1);
        }

        .vehicle-badge {
            background: var(--gradient-primary);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .action-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .action-entry {
            background: var(--gradient-success);
            color: white;
        }

        .action-exit {
            background: var(--gradient-warning);
            color: white;
        }

        /* Charts */
        .chart-container {
            position: relative;
            height: 400px;
            padding: 1rem;
        }

        /* Notifications */
        .notification {
            position: fixed;
            top: 2rem;
            right: 2rem;
            background: rgba(0, 0, 0, 0.95);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 15px;
            border-left: 4px solid var(--primary);
            box-shadow: var(--shadow);
            backdrop-filter: blur(20px);
            z-index: 9999;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            border-left-color: var(--success);
        }

        .notification.error {
            border-left-color: var(--danger);
        }

        /* Floating Stats */
        .floating-stats {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            border-radius: 15px;
            padding: 1.5rem;
            font-size: 0.875rem;
            box-shadow: var(--shadow);
        }

        /* Alert Panel */
        .alert-panel {
            background: var(--gradient-danger);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 15px;
            margin: 1rem 0;
            animation: alertPulse 2s infinite;
            border: none;
        }

        @keyframes alertPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .hero-title { font-size: 2.5rem; }
            .stat-number { font-size: 2rem; }
            .floating-stats { display: none; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .feature-grid { grid-template-columns: 1fr; }
        }

        @media (max-width: 576px) {
            .stats-grid { grid-template-columns: 1fr; }
            .hero-title { font-size: 2rem; }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-dark);
        }
    </style>
</head>
<body>
    <!-- Particles Background -->
    <div id="particles-js"></div>
    
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="fas fa-brain me-2"></i>
                AI Vehicle Intelligence
            </a>
            <div class="nav-controls">
                <div class="status-badge">
                    <div class="status-dot"></div>
                    <span>System Online</span>
                </div>
                <button class="btn btn-outline-light btn-sm me-2" onclick="toggleFullscreen()">
                    <i class="fas fa-expand"></i>
                </button>
                <button class="btn btn-outline-light btn-sm" onclick="toggleTheme()">
                    <i class="fas fa-palette"></i>
                </button>
            </div>
        </div>
    </nav>

    <div class="container-fluid" style="padding-top: 100px;">
        <!-- Hero Section -->
        <div class="hero-section" data-aos="fade-up">
            <h1 class="hero-title">AI Vehicle Intelligence Platform</h1>
            <p class="hero-subtitle">Next-Generation Traffic Monitoring & Analytics System</p>
            
            <div class="feature-grid">
                <div class="feature-card" data-aos="fade-up" data-aos-delay="100">
                    <div class="feature-icon">
                        <i class="fas fa-brain"></i>
                    </div>
                    <h6>YOLOv8 AI Detection</h6>
                    <p class="text-muted">Advanced neural network for precise vehicle identification</p>
                </div>
                <div class="feature-card" data-aos="fade-up" data-aos-delay="200">
                    <div class="feature-icon">
                        <i class="fas fa-tachometer-alt"></i>
                    </div>
                    <h6>Real-time Tracking</h6>
                    <p class="text-muted">Live vehicle tracking with sub-second response times</p>
                </div>
                <div class="feature-card" data-aos="fade-up" data-aos-delay="300">
                    <div class="feature-icon">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <h6>Advanced Analytics</h6>
                    <p class="text-muted">Comprehensive traffic pattern analysis and insights</p>
                </div>
                <div class="feature-card" data-aos="fade-up" data-aos-delay="400">
                    <div class="feature-icon">
                        <i class="fas fa-shield-alt"></i>
                    </div>
                    <h6>Enterprise Security</h6>
                    <p class="text-muted">Military-grade encryption and data protection</p>
                </div>
            </div>
        </div>

        <!-- AI Model Information -->
        <div class="ai-model-card" data-aos="fade-up">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h5 class="mb-3"><i class="fas fa-microchip me-2"></i>AI Model Status</h5>
                    <div class="row">
                        <div class="col-6">
                            <small class="text-muted">Model</small>
                            <div class="fw-bold">YOLOv8 Ultra</div>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">Confidence</small>
                            <div class="fw-bold" id="currentConfidence">85%</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <small class="text-muted">Performance</small>
                    <div class="performance-bar">
                        <div class="performance-fill" style="width: 92%;"></div>
                    </div>
                    <small class="text-success">92% Efficiency</small>
                </div>
                <div class="col-md-3 text-end">
                    <div class="h2 mb-0 text-primary" id="avgSpeed">47</div>
                    <small class="text-muted">Avg Speed (km/h)</small>
                </div>
            </div>
        </div>

        <!-- Statistics Grid -->
        <div class="stats-grid" data-aos="fade-up">
            <div class="stat-card">
                <div class="stat-number" id="totalVehicles">0</div>
                <div class="stat-label">Total Vehicles</div>
                <div class="stat-trend trend-up">
                    <i class="fas fa-arrow-up"></i> +15.3%
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="carsCount">0</div>
                <div class="stat-label">Cars Detected</div>
                <div class="stat-trend trend-up">
                    <i class="fas fa-car"></i> 68%
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="motorcyclesCount">0</div>
                <div class="stat-label">Motorcycles</div>
                <div class="stat-trend trend-up">
                    <i class="fas fa-motorcycle"></i> 18%
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="busesCount">0</div>
                <div class="stat-label">Buses</div>
                <div class="stat-trend trend-down">
                    <i class="fas fa-bus"></i> 8%
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="trucksCount">0</div>
                <div class="stat-label">Trucks</div>
                <div class="stat-trend trend-up">
                    <i class="fas fa-truck"></i> 6%
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="activeTracks">0</div>
                <div class="stat-label">Active Tracks</div>
                <div class="stat-trend trend-up">
                    <i class="fas fa-crosshairs"></i> Live
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="row">
            <!-- Video Feed -->
            <div class="col-lg-8 mb-4">
                <div class="glass-card" data-aos="fade-right">
                    <div class="video-header">
                        <h5 class="mb-0">
                            <i class="fas fa-video me-2"></i>
                            Live Intelligence Feed
                        </h5>
                        <div class="video-controls">
                            <button class="btn btn-sm btn-outline-light me-2" onclick="toggleHeatmap()">
                                <i class="fas fa-fire"></i> Heatmap
                            </button>
                            <button class="btn btn-sm btn-outline-light" onclick="captureFrame()">
                                <i class="fas fa-camera"></i> Capture
                            </button>
                        </div>
                    </div>
                    <div class="video-section">
                        <img id="videoFeed" class="video-feed" src="/video_feed" alt="AI Video Feed">
                        <div class="video-overlay">
                            <div class="live-badge">LIVE</div>
                            <div class="fps-badge" id="fpsCounter">30 FPS</div>
                        </div>
                    </div>
                    
                    <!-- Traffic Flow -->
                    <div class="row mt-3 px-3">
                        <div class="col-md-6">
                            <div class="traffic-flow">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-arrow-right flow-icon me-3"></i>
                                    <div>
                                        <div class="fw-bold">Inbound Traffic</div>
                                        <small class="text-muted">Vehicles entering</small>
                                    </div>
                                </div>
                                <div class="flow-count" id="inboundCount">0</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="traffic-flow">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-arrow-left flow-icon me-3"></i>
                                    <div>
                                        <div class="fw-bold">Outbound Traffic</div>
                                        <small class="text-muted">Vehicles exiting</small>
                                    </div>
                                </div>
                                <div class="flow-count" id="outboundCount">0</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Control Panel -->
            <div class="col-lg-4 mb-4">
                <div class="control-panel" data-aos="fade-left">
                    <h5 class="mb-4">
                        <i class="fas fa-sliders-h me-2"></i>
                        Mission Control
                    </h5>
                    
                    <!-- Controls -->
                    <div class="mb-4">
                        <button class="btn btn-modern btn-start w-100 mb-2" id="startBtn" onclick="startMonitoring()">
                            <i class="fas fa-play me-2"></i>
                            Initialize Monitoring
                        </button>
                        <button class="btn btn-modern btn-stop w-100 mb-2" id="stopBtn" onclick="stopMonitoring()">
                            <i class="fas fa-stop me-2"></i>
                            Terminate Session
                        </button>
                        <div class="row mb-2">
                            <div class="col-6">
                                <button class="btn btn-modern btn-export w-100 btn-sm" onclick="downloadCSVReport()">
                                    <i class="fas fa-file-csv me-1"></i>
                                    CSV
                                </button>
                            </div>
                            <div class="col-6">
                                <button class="btn btn-modern btn-export w-100 btn-sm" onclick="downloadJSONReport()">
                                    <i class="fas fa-file-code me-1"></i>
                                    JSON
                                </button>
                            </div>
                        </div>
                        <button class="btn btn-outline-light w-100 btn-sm" onclick="refreshData()">
                            <i class="fas fa-sync-alt me-2"></i>
                            Refresh Data
                        </button>
                    </div>

                    <!-- Confidence Threshold -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">Detection Sensitivity: <span id="confidenceValue">85%</span></label>
                        <input type="range" class="form-range" id="confidenceSlider" min="10" max="95" value="85" oninput="updateConfidence(this.value)">
                    </div>

                    <!-- Video Source -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">Intelligence Source</label>
                        <select class="form-select" id="videoSource">
                            <option value="0">Primary Camera</option>
                            <option value="1">Secondary Camera</option>
                            <option value="file">Upload Video File</option>
                            <option value="rtsp">RTSP Stream</option>
                        </select>
                        <small class="text-muted">Restart monitoring to apply changes</small>
                    </div>

                    <!-- System Status -->
                    <div class="mb-4">
                        <h6 class="fw-bold"><i class="fas fa-heartbeat me-2"></i>System Status</h6>
                        <div class="row text-center">
                            <div class="col-4">
                                <div class="small text-muted">CPU</div>
                                <div class="fw-bold text-success" id="cpuUsage">--</div>
                            </div>
                            <div class="col-4">
                                <div class="small text-muted">Memory</div>
                                <div class="fw-bold text-info" id="memoryUsage">--</div>
                            </div>
                            <div class="col-4">
                                <div class="small text-muted">GPU</div>
                                <div class="fw-bold text-warning" id="gpuUsage">--</div>
                            </div>
                        </div>
                    </div>

                    <!-- Data Stream -->
                    <div class="mb-4">
                        <h6 class="fw-bold"><i class="fas fa-terminal me-2"></i>System Log</h6>
                        <div class="data-stream" id="dataStream">
                            <div class="stream-line">[INIT] AI Intelligence System Online</div>
                            <div class="stream-line">[INFO] Neural network loaded successfully</div>
                            <div class="stream-line">[INFO] Camera feed established</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Analytics Section -->
        <div class="row">
            <!-- Traffic Analytics -->
            <div class="col-lg-6 mb-4">
                <div class="glass-card p-4" data-aos="fade-up">
                    <h5 class="mb-3">
                        <i class="fas fa-chart-area me-2"></i>
                        Traffic Intelligence Analytics
                    </h5>
                    <div class="chart-container">
                        <canvas id="trafficChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Vehicle Entry/Exit Log -->
            <div class="col-lg-6 mb-4">
                <div class="glass-card p-4" data-aos="fade-up" data-aos-delay="100">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0">
                            <i class="fas fa-list-alt me-2"></i>
                            Vehicle Activity Log
                        </h5>
                        <div>
                            <button class="btn btn-sm btn-outline-light me-2" onclick="fetchEntryExitLog()">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-light" onclick="clearEntryExitLog()">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div style="height: 400px; overflow-y: auto;">
                        <table class="table table-modern">
                            <thead>
                                <tr>
                                    <th>Timestamp</th>
                                    <th>Vehicle ID</th>
                                    <th>Type</th>
                                    <th>Action</th>
                                    <th>Speed</th>
                                </tr>
                            </thead>
                            <tbody id="entryExitTableBody">
                                <!-- Dynamic content -->
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-2 text-center">
                        <small class="text-muted">Total Records: <span id="totalRecords">0</span></small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Alert Panel -->
        <div class="row">
            <div class="col-12">
                <div class="alert-panel" id="alertPanel" style="display: none;">
                    <h6><i class="fas fa-exclamation-triangle me-2"></i>Traffic Intelligence Alert</h6>
                    <p class="mb-0" id="alertMessage">Anomalous traffic pattern detected in monitoring zone.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Floating Stats -->
    <div class="floating-stats">
        <div class="mb-2"><strong>System Uptime:</strong> <span id="uptime">00:00:00</span></div>
        <div class="mb-2"><strong>Frames Processed:</strong> <span id="processedFrames">0</span></div>
        <div><strong>Detection Rate:</strong> <span id="detectionRate">0/s</span></div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification">
        <span id="notificationText">System ready</span>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    
    <script>
        // Initialize AOS
        AOS.init({
            duration: 1000,
            once: true
        });

        // Initialize Socket.IO
        const socket = io();

        // Initialize particles
        particlesJS('particles-js', {
            particles: {
                number: { value: 100, density: { enable: true, value_area: 1000 } },
                color: { value: '#0066ff' },
                shape: { type: 'circle' },
                opacity: { value: 0.6, random: true },
                size: { value: 3, random: true },
                line_linked: {
                    enable: true,
                    distance: 150,
                    color: '#0066ff',
                    opacity: 0.4,
                    width: 1
                },
                move: {
                    enable: true,
                    speed: 3,
                    direction: 'none',
                    random: true,
                    straight: false,
                    out_mode: 'out',
                    bounce: false
                }
            },
            interactivity: {
                detect_on: 'canvas',
                events: {
                    onhover: { enable: true, mode: 'repulse' },
                    onclick: { enable: true, mode: 'push' },
                    resize: true
                }
            },
            retina_detect: true
        });

        // Socket.IO event handlers
        socket.on('connect', function() {
            console.log('Connected to server');
            addDataStreamLine('[SOCKET] Connected to AI Intelligence Server');
        });

        socket.on('disconnect', function() {
            console.log('Disconnected from server');
            addDataStreamLine('[SOCKET] Connection to server lost');
        });

        socket.on('stats_update', function(data) {
            updateRealTimeStats(data);
        });

        socket.on('status', function(data) {
            addDataStreamLine(`[STATUS] ${data.message}`);
        });

        // Initialize chart
        const trafficCtx = document.getElementById('trafficChart').getContext('2d');
        const trafficChart = new Chart(trafficCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Vehicle Count',
                    data: [],
                    borderColor: '#0066ff',
                    backgroundColor: 'rgba(0, 102, 255, 0.1)',
                    tension: 0.4,
                    fill: true,
                    borderWidth: 3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { 
                        labels: { 
                            color: 'white',
                            font: { size: 14, weight: 'bold' }
                        } 
                    }
                },
                scales: {
                    x: { 
                        ticks: { color: 'white' }, 
                        grid: { color: 'rgba(255,255,255,0.1)' } 
                    },
                    y: { 
                        ticks: { color: 'white' }, 
                        grid: { color: 'rgba(255,255,255,0.1)' } 
                    }
                }
            }
        });

        // Global variables
        let isMonitoring = false;
        let startTime = Date.now();
        let frameCount = 0;
        let detectionCount = 0;
        let entryExitData = [];
        let vehicleIdCounter = 1;
        let statsUpdateInterval;
        let systemHealthInterval;
        let currentVideoSource = '0';
        let currentConfidenceThreshold = 85;

        // Entry/Exit functions
        function addEntryExitRecord(type, action, speed) {
            const now = new Date();
            const record = {
                time: now.toLocaleTimeString(),
                vehicleId: `VH${vehicleIdCounter.toString().padStart(4, '0')}`,
                type: type,
                action: action,
                speed: speed + ' km/h'
            };
            
            entryExitData.unshift(record);
            vehicleIdCounter++;
            
            if (entryExitData.length > 100) {
                entryExitData = entryExitData.slice(0, 100);
            }
            
            updateEntryExitTable();
        }

        function updateEntryExitTable() {
            const tableBody = document.getElementById('entryExitTableBody');
            tableBody.innerHTML = '';
            
            entryExitData.slice(0, 20).forEach(record => {
                const row = document.createElement('tr');
                const actionClass = record.action === 'Entry' ? 'action-entry' : 'action-exit';
                const actionIcon = record.action === 'Entry' ? 'fa-sign-in-alt' : 'fa-sign-out-alt';
                
                row.innerHTML = `
                    <td><small>${record.time}</small></td>
                    <td><span class="vehicle-badge">${record.vehicleId}</span></td>
                    <td><i class="fas fa-${getVehicleIcon(record.type)} me-2"></i>${record.type}</td>
                    <td><span class="action-badge ${actionClass}"><i class="fas ${actionIcon} me-1"></i>${record.action}</span></td>
                    <td><small class="fw-bold">${record.speed}</small></td>
                `;
                
                tableBody.appendChild(row);
            });
            
            // Update total records count
            document.getElementById('totalRecords').textContent = entryExitData.length;
        }

        function clearEntryExitLog() {
            entryExitData = [];
            updateEntryExitTable();
            addDataStreamLine('[CLEAR] Entry/Exit log cleared');
            showNotification('Activity log cleared', 'success');
        }

        function getVehicleIcon(type) {
            const icons = {
                'car': 'car',
                'motorcycle': 'motorcycle', 
                'bus': 'bus',
                'truck': 'truck'
            };
            return icons[type.toLowerCase()] || 'car';
        }

        // API Functions
        async function apiCall(endpoint, method = 'GET', data = null) {
            try {
                const options = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    }
                };
                
                if (data) {
                    options.body = JSON.stringify(data);
                }
                
                const response = await fetch(endpoint, options);
                return await response.json();
            } catch (error) {
                console.error('API call failed:', error);
                showNotification('API Error: ' + error.message, 'error');
                return null;
            }
        }

        // Control functions
        function updateConfidence(value) {
            currentConfidenceThreshold = value;
            document.getElementById('confidenceValue').textContent = value + '%';
            document.getElementById('currentConfidence').textContent = value + '%';
            addDataStreamLine(`[CONFIG] Detection sensitivity updated to ${value}%`);
        }

        async function startMonitoring() {
            if (!isMonitoring) {
                try {
                    showNotification('AI Intelligence System Activated', 'success');
                    addDataStreamLine('[START] Vehicle monitoring protocol initiated');
                    
                    // Call the backend API to start monitoring
                    try {
                        const response = await fetch('/start_monitoring', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                source: currentVideoSource,
                                confidence: currentConfidenceThreshold / 100
                            })
                        });
                        
                        const result = await response.json();
                        
                        if (result.status === 'success') {
                            addDataStreamLine('[API] Backend monitoring started successfully');
                        } else {
                            addDataStreamLine('[DEMO] Running in demonstration mode');
                        }
                    } catch (apiError) {
                        addDataStreamLine('[DEMO] Running in demonstration mode');
                    }
                    
                    // Set monitoring to true
                    isMonitoring = true;
                    
                    // Start real-time updates
                    if (statsUpdateInterval) clearInterval(statsUpdateInterval);
                    if (systemHealthInterval) clearInterval(systemHealthInterval);
                    
                    statsUpdateInterval = setInterval(updateDemoStats, 2000);
                    systemHealthInterval = setInterval(updateDemoSystemHealth, 3000);
                    
                    // Update UI elements
                    const statusDot = document.querySelector('.status-dot');
                    if (statusDot) statusDot.style.background = 'var(--success)';
                    
                    const statusText = document.querySelector('.status-badge span');
                    if (statusText) statusText.textContent = 'System Active';
                    
                    // Update button states
                    updateButtonStates(true);
                    
                    // Start demo data immediately
                    updateDemoStats();
                    updateDemoSystemHealth();
                    
                } catch (error) {
                    showNotification('Error: ' + error.message, 'error');
                }
            } else {
                showNotification('Monitoring is already active', 'warning');
            }
        }

        function stopMonitoring() {
            console.log('Stop Monitoring button clicked!');
            addDataStreamLine('[DEBUG] Stop Monitoring function called');
            
            if (isMonitoring) {
                console.log('Stopping monitoring process...');
                showNotification('Terminating monitoring session...', 'success');
                addDataStreamLine('[STOP] Shutting down vehicle monitoring protocol...');
                
                // Set monitoring to false
                isMonitoring = false;
                
                showNotification('Monitoring Session Terminated', 'success');
                addDataStreamLine('[STOP] Vehicle monitoring protocol deactivated');
                addDataStreamLine('[DEMO] Demo mode stopped');
                
                // Clear intervals
                if (statsUpdateInterval) {
                    clearInterval(statsUpdateInterval);
                    statsUpdateInterval = null;
                    console.log('Stats interval cleared');
                }
                if (systemHealthInterval) {
                    clearInterval(systemHealthInterval);
                    systemHealthInterval = null;
                    console.log('System health interval cleared');
                }
                
                // Update UI elements
                const statusDot = document.querySelector('.status-dot');
                if (statusDot) {
                    statusDot.style.background = 'var(--danger)';
                    console.log('Status dot updated to red');
                }
                
                const statusText = document.querySelector('.status-badge span');
                if (statusText) {
                    statusText.textContent = 'System Standby';
                    console.log('Status text updated to standby');
                }
                
                // Update button states
                updateButtonStates(false);
                console.log('Button states updated to stopped');
                
                // Reset stats to zero
                resetStats();
                console.log('Stats reset to zero');
                
            } else {
                console.log('Monitoring not currently active');
                showNotification('Monitoring is not currently active', 'warning');
            }
        }

        async function exportData() {
            showNotification('Intelligence Export Initiated', 'success');
            addDataStreamLine('[EXPORT] Generating comprehensive data export...');
            
            try {
                const response = await fetch('/api/export_data?format=json');
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `vehicle_intelligence_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                
                addDataStreamLine('[EXPORT] Intelligence data export completed');
                showNotification('Data exported successfully', 'success');
            } catch (error) {
                addDataStreamLine('[ERROR] Export failed: ' + error.message);
                showNotification('Export failed', 'error');
            }
        }

        // Demo data functions
        function updateDemoStats() {
            console.log('📊 updateDemoStats called, isMonitoring:', isMonitoring);
            
            if (!isMonitoring) {
                console.log('⚠️ Not monitoring, skipping stats update');
                return;
            }
            
            try {
                const demoStats = {
                    total_vehicles: Math.floor(Math.random() * 150) + frameCount,
                    vehicle_counts: {
                        car: Math.floor(Math.random() * 80) + 20,
                        motorcycle: Math.floor(Math.random() * 30) + 10,
                        bus: Math.floor(Math.random() * 15) + 5,
                        truck: Math.floor(Math.random() * 20) + 8
                    },
                    active_tracks: Math.floor(Math.random() * 25) + 8,
                    traffic_flow: {
                        inbound: Math.floor(Math.random() * 75) + 25,
                        outbound: Math.floor(Math.random() * 75) + 25
                    },
                    fps: 28 + Math.floor(Math.random() * 7),
                    avg_speed: 35 + Math.floor(Math.random() * 30),
                    timestamp: new Date().toISOString()
                };
                
                console.log('📈 Demo stats generated:', demoStats);
                updateRealTimeStats(demoStats);
                
                // Add demo entry/exit records
                if (Math.random() < 0.4) {
                    const vehicleTypes = ['Car', 'Motorcycle', 'Bus', 'Truck'];
                    const actions = ['Entry', 'Exit'];
                    const type = vehicleTypes[Math.floor(Math.random() * vehicleTypes.length)];
                    const action = actions[Math.floor(Math.random() * actions.length)];
                    const speed = Math.floor(Math.random() * 70) + 15;
                    
                    addEntryExitRecord(type, action, speed);
                    addDataStreamLine(`[DETECT] ${type} ${action.toLowerCase()} - Velocity: ${speed} km/h`);
                }
                
                // Update frame count
                frameCount += Math.floor(Math.random() * 8) + 3;
                detectionCount += Math.floor(Math.random() * 5) + 2;
                
                const processedFramesEl = document.getElementById('processedFrames');
                const detectionRateEl = document.getElementById('detectionRate');
                
                if (processedFramesEl) processedFramesEl.textContent = frameCount.toLocaleString();
                if (detectionRateEl) detectionRateEl.textContent = Math.floor(detectionCount / ((Date.now() - startTime) / 1000)) + '/s';
                
                console.log('✅ Demo stats updated successfully');
                
            } catch (error) {
                console.error('❌ Error in updateDemoStats:', error);
            }
        }
        
        function updateDemoSystemHealth() {
            if (!isMonitoring) return;
            
            const demoHealth = {
                cpu_usage: 15 + Math.random() * 30,
                memory_usage: 40 + Math.random() * 20,
                gpu_usage: 20 + Math.random() * 25,
                fps: 28 + Math.floor(Math.random() * 7),
                total_frames: frameCount
            };
            
            updateSystemHealth(demoHealth);
        }
        
        // Button state management
        function updateButtonStates(monitoring) {
            console.log('Updating button states, monitoring:', monitoring);
            const startBtn = document.querySelector('.btn-start');
            const stopBtn = document.querySelector('.btn-stop');
            
            console.log('Start button found:', !!startBtn);
            console.log('Stop button found:', !!stopBtn);
            
            if (startBtn && stopBtn) {
                if (monitoring) {
                    startBtn.disabled = true;
                    startBtn.innerHTML = '<i class="fas fa-check me-2"></i>Monitoring Active';
                    startBtn.style.opacity = '0.7';
                    startBtn.style.background = 'var(--gradient-success)';
                    
                    stopBtn.disabled = false;
                    stopBtn.innerHTML = '<i class="fas fa-stop me-2"></i>Terminate Session';
                    stopBtn.style.opacity = '1';
                    
                    console.log('Buttons updated for monitoring active state');
                } else {
                    startBtn.disabled = false;
                    startBtn.innerHTML = '<i class="fas fa-play me-2"></i>Initialize Monitoring';
                    startBtn.style.opacity = '1';
                    startBtn.style.background = 'var(--gradient-success)';
                    
                    stopBtn.disabled = true;
                    stopBtn.innerHTML = '<i class="fas fa-stop me-2"></i>Session Inactive';
                    stopBtn.style.opacity = '0.7';
                    
                    console.log('Buttons updated for monitoring inactive state');
                }
            } else {
                console.error('Could not find start or stop buttons!');
            }
        }
        
        // Reset statistics
        function resetStats() {
            updateStatNumber('totalVehicles', 0);
            updateStatNumber('carsCount', 0);
            updateStatNumber('motorcyclesCount', 0);
            updateStatNumber('busesCount', 0);
            updateStatNumber('trucksCount', 0);
            updateStatNumber('activeTracks', 0);
            
            document.getElementById('inboundCount').textContent = '0';
            document.getElementById('outboundCount').textContent = '0';
            document.getElementById('fpsCounter').textContent = '0 FPS';
            document.getElementById('avgSpeed').textContent = '0';
        }

        // Real-time data fetching (with fallback)
        async function fetchRealTimeStats() {
            try {
                const stats = await apiCall('/api/stats');
                if (stats && !stats.error) {
                    updateRealTimeStats(stats);
                } else {
                    updateDemoStats();
                }
            } catch (error) {
                console.error('Failed to fetch stats:', error);
                updateDemoStats();
            }
        }

        async function fetchSystemHealth() {
            try {
                const health = await apiCall('/api/system_health');
                if (health) {
                    updateSystemHealth(health);
                } else {
                    updateDemoSystemHealth();
                }
            } catch (error) {
                console.error('Failed to fetch system health:', error);
                updateDemoSystemHealth();
            }
        }

        async function fetchEntryExitLog() {
            const log = await apiCall('/api/entry_exit_log');
            if (log && Array.isArray(log)) {
                entryExitData = log;
                updateEntryExitTable();
            }
        }

        async function fetchAnomalies() {
            const anomalies = await apiCall('/api/anomalies');
            if (anomalies) {
                updateAnomalies(anomalies);
            }
        }

        // Real-time stats update
        function updateRealTimeStats(stats) {
            if (stats.total_vehicles !== undefined) {
                updateStatNumber('totalVehicles', stats.total_vehicles);
            }
            if (stats.vehicle_counts) {
                updateStatNumber('carsCount', stats.vehicle_counts.car || 0);
                updateStatNumber('motorcyclesCount', stats.vehicle_counts.motorcycle || 0);
                updateStatNumber('busesCount', stats.vehicle_counts.bus || 0);
                updateStatNumber('trucksCount', stats.vehicle_counts.truck || 0);
            }
            if (stats.active_tracks !== undefined) {
                updateStatNumber('activeTracks', stats.active_tracks);
            }
            if (stats.traffic_flow) {
                document.getElementById('inboundCount').textContent = stats.traffic_flow.inbound || 0;
                document.getElementById('outboundCount').textContent = stats.traffic_flow.outbound || 0;
            }
            if (stats.fps !== undefined) {
                document.getElementById('fpsCounter').textContent = stats.fps + ' FPS';
            }
            if (stats.avg_speed !== undefined) {
                document.getElementById('avgSpeed').textContent = Math.round(stats.avg_speed);
            }
            
            // Update charts with real data
            if (stats.timestamp && stats.total_vehicles !== undefined) {
                updateChartsWithRealData(stats.timestamp, stats.total_vehicles);
            }
            
            // Update entry/exit log if available
            if (stats.recent_detections) {
                updateEntryExitFromStats(stats.recent_detections);
            }
        }

        function updateSystemHealth(health) {
            if (health.cpu_usage !== undefined) {
                const cpuBar = document.querySelector('.performance-fill');
                if (cpuBar) {
                    cpuBar.style.width = (100 - health.cpu_usage) + '%';
                }
                document.getElementById('cpuUsage').textContent = health.cpu_usage.toFixed(1) + '%';
            }
            
            if (health.memory_usage !== undefined) {
                document.getElementById('memoryUsage').textContent = health.memory_usage.toFixed(1) + '%';
                addDataStreamLine(`[SYSTEM] Memory usage: ${health.memory_usage.toFixed(1)}%`);
            }
            
            if (health.gpu_usage !== undefined) {
                document.getElementById('gpuUsage').textContent = health.gpu_usage.toFixed(1) + '%';
            }
            
            if (health.fps !== undefined) {
                document.getElementById('processedFrames').textContent = health.total_frames || frameCount;
            }
        }

        function updateAnomalies(anomalies) {
            if (anomalies.active_anomalies && anomalies.active_anomalies.length > 0) {
                anomalies.active_anomalies.forEach(anomaly => {
                    showAlert(`Anomaly detected: ${anomaly.description}`);
                    addDataStreamLine(`[ANOMALY] ${anomaly.type}: ${anomaly.description}`);
                });
            }
        }

        function updateEntryExitFromStats(detections) {
            detections.forEach(detection => {
                if (detection.action && detection.vehicle_type) {
                    addEntryExitRecord(
                        detection.vehicle_type,
                        detection.action,
                        detection.speed || Math.floor(Math.random() * 60) + 20
                    );
                }
            });
        }

        function updateChartsWithRealData(timestamp, vehicleCount) {
            const timeLabel = new Date(timestamp).toLocaleTimeString();
            
            trafficChart.data.labels.push(timeLabel);
            trafficChart.data.datasets[0].data.push(vehicleCount);
            
            if (trafficChart.data.labels.length > 15) {
                trafficChart.data.labels.shift();
                trafficChart.data.datasets[0].data.shift();
            }
            
            trafficChart.update('none');
        }

        function toggleHeatmap() {
            showNotification('Thermal Analysis Toggled', 'success');
        }

        function captureFrame() {
            showNotification('Frame Captured Successfully', 'success');
            addDataStreamLine('[CAPTURE] High-resolution frame archived');
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }

        function toggleTheme() {
            showNotification('Interface Theme Updated', 'success');
        }

        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notificationText');
            
            notificationText.textContent = message;
            notification.className = `notification ${type} show`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 4000);
        }

        function addDataStreamLine(message) {
            const dataStream = document.getElementById('dataStream');
            const timestamp = new Date().toLocaleTimeString();
            const line = document.createElement('div');
            line.className = 'stream-line';
            line.textContent = `[${timestamp}] ${message}`;
            
            dataStream.appendChild(line);
            dataStream.scrollTop = dataStream.scrollHeight;
            
            while (dataStream.children.length > 25) {
                dataStream.removeChild(dataStream.firstChild);
            }
        }

        // Video source change handler
        function onVideoSourceChange() {
            const select = document.getElementById('videoSource');
            currentVideoSource = select.value;
            addDataStreamLine(`[CONFIG] Video source changed to: ${select.options[select.selectedIndex].text}`);
            
            if (isMonitoring) {
                showNotification('Restart monitoring to apply video source change', 'warning');
            }
        }

        // Fallback stats update for demo purposes
        function updateStats() {
            if (!isMonitoring) return;
            
            // This is a fallback - real data should come from API
            frameCount += Math.floor(Math.random() * 8) + 3;
            detectionCount += Math.floor(Math.random() * 5) + 2;
            
            document.getElementById('processedFrames').textContent = frameCount.toLocaleString();
            document.getElementById('detectionRate').textContent = Math.floor(detectionCount / ((Date.now() - startTime) / 1000)) + '/s';
        }

        function updateStatNumber(elementId, value) {
            const element = document.getElementById(elementId);
            if (element.textContent !== value.toString()) {
                element.textContent = value.toLocaleString();
                element.style.transform = 'scale(1.1)';
                setTimeout(() => element.style.transform = 'scale(1)', 300);
            }
        }

        function updateUptime() {
            const uptime = Date.now() - startTime;
            const hours = Math.floor(uptime / 3600000);
            const minutes = Math.floor((uptime % 3600000) / 60000);
            const seconds = Math.floor((uptime % 60000) / 1000);
            
            document.getElementById('uptime').textContent = 
                `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        // Enhanced chart updates
        function updateCharts() {
            // This is now handled by updateChartsWithRealData
            // Keeping for backward compatibility
        }

        // Load historical data
        async function loadHistoricalData() {
            try {
                const trendData = await apiCall('/api/trend_data');
                if (trendData && trendData.hourly_counts) {
                    // Update chart with historical data
                    trafficChart.data.labels = trendData.labels || [];
                    trafficChart.data.datasets[0].data = trendData.hourly_counts || [];
                    trafficChart.update();
                }
            } catch (error) {
                console.error('Failed to load historical data:', error);
            }
        }

        function showAlert(message) {
            const alertPanel = document.getElementById('alertPanel');
            const alertMessage = document.getElementById('alertMessage');
            
            alertMessage.textContent = message;
            alertPanel.style.display = 'block';
            
            setTimeout(() => {
                alertPanel.style.display = 'none';
            }, 6000);
        }

        // Initialize system
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM Content Loaded - Initializing system...');
            showNotification('AI Intelligence Platform Initialized', 'success');
            addDataStreamLine('[INIT] Neural network architecture loaded');
            
            // Set up event listeners
            const videoSourceSelect = document.getElementById('videoSource');
            if (videoSourceSelect) {
                videoSourceSelect.addEventListener('change', onVideoSourceChange);
                console.log('Video source event listener added');
            }
            
            // Verify buttons are working
            console.log('Checking for buttons...');
            const startBtn = document.getElementById('startBtn');
            const stopBtn = document.getElementById('stopBtn');
            
            if (startBtn) {
                console.log('Start button found with ID');
            } else {
                console.error('Start button not found!');
            }
            
            if (stopBtn) {
                console.log('Stop button found with ID');
            } else {
                console.error('Stop button not found!');
            }
            
            // Start uptime counter
            setInterval(updateUptime, 1000);
            
            // Load initial data
            loadHistoricalData();
            fetchEntryExitLog();
            fetchSystemHealth();
            
            // Periodic updates for non-monitoring data
            setInterval(fetchAnomalies, 10000);
            
            // Enable auto-refresh
            enableAutoRefresh(15000);
            
            // Initialize button states
            updateButtonStates(false);
            console.log('Initial button states set');
            
            setTimeout(() => {
                addDataStreamLine('[INFO] Camera calibration protocols complete');
                addDataStreamLine('[INFO] AI model optimization finished');
                addDataStreamLine('[INFO] System ready for vehicle intelligence operations');
                addDataStreamLine('[API] Real-time data integration active');
                addDataStreamLine('[DEBUG] Mission Control buttons initialized and ready');
                
                // Load initial entry/exit records if none exist
                if (entryExitData.length === 0) {
                    addEntryExitRecord('Car', 'Entry', 52);
                    addEntryExitRecord('Motorcycle', 'Exit', 38);
                    addEntryExitRecord('Bus', 'Entry', 28);
                    addEntryExitRecord('Truck', 'Entry', 45);
                }
                
                // Initialize with demo system health
                updateDemoSystemHealth();
                
                console.log('System initialization complete');
                
            }, 3000);
        });

        // Enhanced functionality
        function refreshData() {
            showNotification('Refreshing data...', 'info');
            addDataStreamLine('[REFRESH] Manual data refresh initiated');
            
            if (isMonitoring) {
                updateDemoStats();
                updateDemoSystemHealth();
                fetchRealTimeStats();
                fetchSystemHealth();
            } else {
                loadHistoricalData();
                updateDemoSystemHealth();
            }
            
            showNotification('Data refreshed successfully', 'success');
        }
        
        // Advanced analytics functions
        async function loadTrafficPatterns() {
            try {
                const response = await fetch('/api/trend_data');
                const data = await response.json();
                
                if (data && data.hourly_patterns) {
                    updateTrafficPatternChart(data.hourly_patterns);
                    addDataStreamLine('[ANALYTICS] Traffic patterns loaded');
                }
            } catch (error) {
                console.error('Failed to load traffic patterns:', error);
                const demoPatterns = generateDemoTrafficPatterns();
                updateTrafficPatternChart(demoPatterns);
            }
        }
        
        function generateDemoTrafficPatterns() {
            const hours = [];
            const counts = [];
            
            for (let i = 0; i < 24; i++) {
                hours.push(i + ':00');
                let count = 10;
                if (i >= 7 && i <= 9) count = Math.random() * 80 + 60;
                else if (i >= 17 && i <= 19) count = Math.random() * 90 + 70;
                else if (i >= 10 && i <= 16) count = Math.random() * 50 + 30;
                else count = Math.random() * 20 + 5;
                
                counts.push(Math.floor(count));
            }
            
            return { hours, counts };
        }
        
        function updateTrafficPatternChart(data) {
            if (trafficChart) {
                trafficChart.data.labels = data.hours || data.labels || [];
                trafficChart.data.datasets[0].data = data.counts || data.data || [];
                trafficChart.update();
            }
        }
        
        // Speed monitoring
        function updateSpeedMonitoring() {
            const avgSpeed = 35 + Math.random() * 30;
            document.getElementById('avgSpeed').textContent = Math.round(avgSpeed);
            
            if (avgSpeed > 60) {
                showAlert('High average speed detected: ' + Math.round(avgSpeed) + ' km/h');
                addDataStreamLine('[ALERT] High speed detected: ' + Math.round(avgSpeed) + ' km/h');
            }
        }
        
        // Traffic density analysis
        function analyzeTrafficDensity() {
            const currentHour = new Date().getHours();
            let density = 'Low';
            let color = '#4CAF50';
            
            if ((currentHour >= 7 && currentHour <= 9) || (currentHour >= 17 && currentHour <= 19)) {
                density = 'High';
                color = '#f44336';
            } else if (currentHour >= 10 && currentHour <= 16) {
                density = 'Medium';
                color = '#ff9800';
            }
            
            const densityElement = document.getElementById('trafficDensity');
            if (densityElement) {
                densityElement.textContent = density;
                densityElement.style.color = color;
            }
            
            return density;
        }
        
        // Enhanced export functionality
        async function exportDetailedReport() {
            try {
                showNotification('Generating detailed report...', 'info');
                addDataStreamLine('[EXPORT] Generating comprehensive analytics report');
                
                const reportData = {
                    timestamp: new Date().toISOString(),
                    summary: {
                        total_vehicles: document.getElementById('totalVehicles').textContent,
                        cars: document.getElementById('carsCount').textContent,
                        motorcycles: document.getElementById('motorcyclesCount').textContent,
                        buses: document.getElementById('busesCount').textContent,
                        trucks: document.getElementById('trucksCount').textContent,
                        active_tracks: document.getElementById('activeTracks').textContent,
                        avg_speed: document.getElementById('avgSpeed').textContent + ' km/h',
                        system_uptime: document.getElementById('uptime').textContent
                    },
                    vehicle_log: entryExitData,
                    system_health: {
                        cpu_usage: document.getElementById('cpuUsage').textContent,
                        memory_usage: document.getElementById('memoryUsage').textContent,
                        gpu_usage: document.getElementById('gpuUsage').textContent,
                        fps: document.getElementById('fpsCounter').textContent,
                        processed_frames: document.getElementById('processedFrames').textContent
                    },
                    traffic_analysis: {
                        density: analyzeTrafficDensity(),
                        peak_hours: ['07:00-09:00', '17:00-19:00'],
                        classification_accuracy: '92%'
                    }
                };
                
                const jsonData = JSON.stringify(reportData, null, 2);
                const blob = new Blob([jsonData], { type: 'application/json' });
                downloadBlob(blob, 'json', 'detailed_report');
                
                showNotification('Detailed report exported successfully', 'success');
                addDataStreamLine('[EXPORT] Detailed analytics report completed');
                
            } catch (error) {
                showNotification('Failed to generate detailed report', 'error');
                addDataStreamLine('[ERROR] Report generation failed: ' + error.message);
            }
        }

        async function downloadCSVReport() {
            try {
                showNotification('Generating CSV report...', 'info');
                addDataStreamLine('[EXPORT] CSV report generation initiated');
                
                // Try API first, fallback to demo data
                try {
                    const response = await fetch('/api/export_data?format=csv');
                    if (response.ok) {
                        const blob = await response.blob();
                        downloadBlob(blob, 'csv');
                    } else {
                        throw new Error('API not available');
                    }
                } catch (apiError) {
                    // Generate demo CSV data
                    const csvData = generateDemoCSV();
                    const blob = new Blob([csvData], { type: 'text/csv' });
                    downloadBlob(blob, 'csv');
                    addDataStreamLine('[DEMO] Generated demo CSV data');
                }
                
                showNotification('CSV report downloaded successfully', 'success');
                addDataStreamLine('[EXPORT] CSV report download completed');
            } catch (error) {
                console.error('CSV export error:', error);
                showNotification('Failed to download CSV report', 'error');
                addDataStreamLine('[ERROR] CSV export failed: ' + error.message);
            }
        }

        async function downloadJSONReport() {
            try {
                showNotification('Generating JSON report...', 'info');
                addDataStreamLine('[EXPORT] JSON report generation initiated');
                
                // Try API first, fallback to demo data
                try {
                    const response = await fetch('/api/export_data?format=json');
                    if (response.ok) {
                        const blob = await response.blob();
                        downloadBlob(blob, 'json');
                    } else {
                        throw new Error('API not available');
                    }
                } catch (apiError) {
                    // Generate demo JSON data
                    const jsonData = generateDemoJSON();
                    const blob = new Blob([jsonData], { type: 'application/json' });
                    downloadBlob(blob, 'json');
                    addDataStreamLine('[DEMO] Generated demo JSON data');
                }
                
                showNotification('JSON report downloaded successfully', 'success');
                addDataStreamLine('[EXPORT] JSON report download completed');
            } catch (error) {
                console.error('JSON export error:', error);
                showNotification('Failed to download JSON report', 'error');
                addDataStreamLine('[ERROR] JSON export failed: ' + error.message);
            }
        }
        
        function downloadBlob(blob, format, prefix = 'vehicle_data') {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${prefix}_${new Date().toISOString().split('T')[0]}.${format}`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }
        
        function generateDemoCSV() {
            let csv = 'Timestamp,Vehicle ID,Type,Action,Speed\n';
            entryExitData.forEach(record => {
                csv += `${record.time},${record.vehicleId},${record.type},${record.action},${record.speed}\n`;
            });
            return csv;
        }
        
        function generateDemoJSON() {
            return JSON.stringify({
                export_date: new Date().toISOString(),
                total_records: entryExitData.length,
                vehicle_data: entryExitData,
                summary: {
                    total_vehicles: document.getElementById('totalVehicles').textContent,
                    cars: document.getElementById('carsCount').textContent,
                    motorcycles: document.getElementById('motorcyclesCount').textContent,
                    buses: document.getElementById('busesCount').textContent,
                    trucks: document.getElementById('trucksCount').textContent
                }
            }, null, 2);
        }

        // Error handling
        window.addEventListener('error', function(e) {
            console.error('JavaScript error:', e.error);
            addDataStreamLine(`[ERROR] ${e.error.message}`);
        });

        // Connection status monitoring
        window.addEventListener('online', function() {
            showNotification('Connection restored', 'success');
            addDataStreamLine('[NETWORK] Connection restored');
            document.querySelector('.status-badge span').textContent = 'System Online';
        });

        window.addEventListener('offline', function() {
            showNotification('Connection lost', 'error');
            addDataStreamLine('[NETWORK] Connection lost');
            document.querySelector('.status-badge span').textContent = 'System Offline';
        });

        // Auto-refresh functionality
        function enableAutoRefresh(interval = 30000) {
            setInterval(() => {
                if (isMonitoring) {
                    fetchRealTimeStats();
                    fetchSystemHealth();
                }
            }, interval);
        }

        // Performance monitoring
        function monitorPerformance() {
            if ('performance' in window) {
                const navigation = performance.getEntriesByType('navigation')[0];
                if (navigation) {
                    addDataStreamLine(`[PERF] Page load time: ${navigation.loadEventEnd - navigation.loadEventStart}ms`);
                }
            }
        }

        // Initialize performance monitoring
        window.addEventListener('load', monitorPerformance);
    </script>
</body>
</html>